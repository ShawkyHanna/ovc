#!/usr/bin/env python3
from nmigen import *


class FCS(Elaboratable):
    '''
    Ethernet FCS calculator for a 64-bit datapath
    '''

    def __init__(self):
        self.data = Signal(64)
        self.crc = Signal(32)
        self.clear = Signal()
        self.valid = Signal(8)  # indicates which bytes are valid

        # these ports are just for testing
        self.crc64 = Signal(32)
        self.crc48 = Signal(32)

    def elaborate(self, platform):
        m = Module()

        # internal signal with the reversed inverted CRC
        c64 = Signal(32, reset=0xffff_ffff)
        c48 = Signal(32, reset=0xffff_ffff)  # the 6-byte (48-bit) version

        # pipeline the valid signal so we can later choose the right FCS
        valid_d1 = Signal(8)
        valid_d2 = Signal(8)
        m.d.sync += [
            valid_d1.eq(self.valid),
            valid_d2.eq(valid_d1),
        ]

        with m.If(valid_d2 == 0xff):
            m.d.sync += [self.crc.eq(~c64[::-1])]
        with m.Elif(valid_d2 == 0x3f):
            m.d.sync += [self.crc.eq(~c48[::-1])]
        with m.Else():
            m.d.sync += [self.crc.eq(self.crc)]

        # register the data in this module to help timing
        d64 = Signal(64)
        d48 = Signal(48)

        # flip the inbound bits around, because reasons
        # could be smarter and index the 48-bit case differently to re-use
        # the "full" 64-bit data register, but that might end up making the
        # P&R more congested, so who knows what's better.
        m.d.sync += [
            d64.eq(self.data[::-1]),
            d48.eq(self.data[47:0:-1])
        ]

        with m.If(self.clear):
            m.d.sync += [
                self.crc64.eq(self.crc64.reset),
                self.crc48.eq(self.crc48.reset),
            ]
        with m.Elif(valid_d2 == 0x00):
            pass
        with m.Else():
            m.d.sync += [
                # flip bits back around and invert, because reasons
                self.crc64.eq(~c64[::-1]),
                self.crc48.eq(~c48[::-1]),
            ]

        with m.If(self.clear):
            m.d.sync += [
                c64.eq(c64.reset),
                c48.eq(c48.reset)
            ]
        with m.Elif(valid_d1 == 0x00):
            pass
            #m.d.sync += [
            #    self.crc64.eq(~c64[::-1]),
            #    self.crc48.eq(~c48[::-1]),
            #]
        with m.Else():
            m.d.sync += [
                # 6-byte (48-bit) excitement
                c48.eq(
                    Cat(
                        c64[0] ^ c64[8] ^ c64[9] ^ c64[10] ^ c64[12] ^ c64[13] ^ c64[14] ^ c64[15] ^ c64[16] ^ c64[18] ^ c64[21] ^ c64[28] ^ c64[29] ^ c64[31] ^ d48[0] ^ d48[6] ^ d48[9] ^ d48[10] ^ d48[12] ^ d48[16] ^ d48[24] ^ d48[25] ^ d48[26] ^ d48[28] ^ d48[29] ^ d48[30] ^ d48[31] ^ d48[32] ^ d48[34] ^ d48[37] ^ d48[44] ^ d48[45] ^ d48[47],
                        c64[0] ^ c64[1] ^ c64[8] ^ c64[11] ^ c64[12] ^ c64[17] ^ c64[18] ^ c64[19] ^ c64[21] ^ c64[22] ^ c64[28] ^ c64[30] ^ c64[31] ^ d48[0] ^ d48[1] ^ d48[6] ^ d48[7] ^ d48[9] ^ d48[11] ^ d48[12] ^ d48[13] ^ d48[16] ^ d48[17] ^ d48[24] ^ d48[27] ^ d48[28] ^ d48[33] ^ d48[34] ^ d48[35] ^ d48[37] ^ d48[38] ^ d48[44] ^ d48[46] ^ d48[47],
                        c64[0] ^ c64[1] ^ c64[2] ^ c64[8] ^ c64[10] ^ c64[14] ^ c64[15] ^ c64[16] ^ c64[19] ^ c64[20] ^ c64[21] ^ c64[22] ^ c64[23] ^ c64[28] ^ d48[0] ^ d48[1] ^ d48[2] ^ d48[6] ^ d48[7] ^ d48[8] ^ d48[9] ^ d48[13] ^ d48[14] ^ d48[16] ^ d48[17] ^ d48[18] ^ d48[24] ^ d48[26] ^ d48[30] ^ d48[31] ^ d48[32] ^ d48[35] ^ d48[36] ^ d48[37] ^ d48[38] ^ d48[39] ^ d48[44],
                        c64[1] ^ c64[2] ^ c64[3] ^ c64[9] ^ c64[11] ^ c64[15] ^ c64[16] ^ c64[17] ^ c64[20] ^ c64[21] ^ c64[22] ^ c64[23] ^ c64[24] ^ c64[29] ^ d48[1] ^ d48[2] ^ d48[3] ^ d48[7] ^ d48[8] ^ d48[9] ^ d48[10] ^ d48[14] ^ d48[15] ^ d48[17] ^ d48[18] ^ d48[19] ^ d48[25] ^ d48[27] ^ d48[31] ^ d48[32] ^ d48[33] ^ d48[36] ^ d48[37] ^ d48[38] ^ d48[39] ^ d48[40] ^ d48[45],
                        c64[2] ^ c64[3] ^ c64[4] ^ c64[8] ^ c64[9] ^ c64[13] ^ c64[14] ^ c64[15] ^ c64[17] ^ c64[22] ^ c64[23] ^ c64[24] ^ c64[25] ^ c64[28] ^ c64[29] ^ c64[30] ^ c64[31] ^ d48[0] ^ d48[2] ^ d48[3] ^ d48[4] ^ d48[6] ^ d48[8] ^ d48[11] ^ d48[12] ^ d48[15] ^ d48[18] ^ d48[19] ^ d48[20] ^ d48[24] ^ d48[25] ^ d48[29] ^ d48[30] ^ d48[31] ^ d48[33] ^ d48[38] ^ d48[39] ^ d48[40] ^ d48[41] ^ d48[44] ^ d48[45] ^ d48[46] ^ d48[47],
                        c64[3] ^ c64[4] ^ c64[5] ^ c64[8] ^ c64[12] ^ c64[13] ^ c64[21] ^ c64[23] ^ c64[24] ^ c64[25] ^ c64[26] ^ c64[28] ^ c64[30] ^ d48[0] ^ d48[1] ^ d48[3] ^ d48[4] ^ d48[5] ^ d48[6] ^ d48[7] ^ d48[10] ^ d48[13] ^ d48[19] ^ d48[20] ^ d48[21] ^ d48[24] ^ d48[28] ^ d48[29] ^ d48[37] ^ d48[39] ^ d48[40] ^ d48[41] ^ d48[42] ^ d48[44] ^ d48[46],
                        c64[4] ^ c64[5] ^ c64[6] ^ c64[9] ^ c64[13] ^ c64[14] ^ c64[22] ^ c64[24] ^ c64[25] ^ c64[26] ^ c64[27] ^ c64[29] ^ c64[31] ^ d48[1] ^ d48[2] ^ d48[4] ^ d48[5] ^ d48[6] ^ d48[7] ^ d48[8] ^ d48[11] ^ d48[14] ^ d48[20] ^ d48[21] ^ d48[22] ^ d48[25] ^ d48[29] ^ d48[30] ^ d48[38] ^ d48[40] ^ d48[41] ^ d48[42] ^ d48[43] ^ d48[45] ^ d48[47],
                        c64[0] ^ c64[5] ^ c64[6] ^ c64[7] ^ c64[8] ^ c64[9] ^ c64[12] ^ c64[13] ^ c64[16] ^ c64[18] ^ c64[21] ^ c64[23] ^ c64[25] ^ c64[26] ^ c64[27] ^ c64[29] ^ c64[30] ^ c64[31] ^ d48[0] ^ d48[2] ^ d48[3] ^ d48[5] ^ d48[7] ^ d48[8] ^ d48[10] ^ d48[15] ^ d48[16] ^ d48[21] ^ d48[22] ^ d48[23] ^ d48[24] ^ d48[25] ^ d48[28] ^ d48[29] ^ d48[32] ^ d48[34] ^ d48[37] ^ d48[39] ^ d48[41] ^ d48[42] ^ d48[43] ^ d48[45] ^ d48[46] ^ d48[47],
                        c64[1] ^ c64[6] ^ c64[7] ^ c64[12] ^ c64[15] ^ c64[16] ^ c64[17] ^ c64[18] ^ c64[19] ^ c64[21] ^ c64[22] ^ c64[24] ^ c64[26] ^ c64[27] ^ c64[29] ^ c64[30] ^ d48[0] ^ d48[1] ^ d48[3] ^ d48[4] ^ d48[8] ^ d48[10] ^ d48[11] ^ d48[12] ^ d48[17] ^ d48[22] ^ d48[23] ^ d48[28] ^ d48[31] ^ d48[32] ^ d48[33] ^ d48[34] ^ d48[35] ^ d48[37] ^ d48[38] ^ d48[40] ^ d48[42] ^ d48[43] ^ d48[45] ^ d48[46],
                        c64[2] ^ c64[7] ^ c64[8] ^ c64[13] ^ c64[16] ^ c64[17] ^ c64[18] ^ c64[19] ^ c64[20] ^ c64[22] ^ c64[23] ^ c64[25] ^ c64[27] ^ c64[28] ^ c64[30] ^ c64[31] ^ d48[1] ^ d48[2] ^ d48[4] ^ d48[5] ^ d48[9] ^ d48[11] ^ d48[12] ^ d48[13] ^ d48[18] ^ d48[23] ^ d48[24] ^ d48[29] ^ d48[32] ^ d48[33] ^ d48[34] ^ d48[35] ^ d48[36] ^ d48[38] ^ d48[39] ^ d48[41] ^ d48[43] ^ d48[44] ^ d48[46] ^ d48[47],
                        c64[0] ^ c64[3] ^ c64[10] ^ c64[12] ^ c64[13] ^ c64[15] ^ c64[16] ^ c64[17] ^ c64[19] ^ c64[20] ^ c64[23] ^ c64[24] ^ c64[26] ^ d48[0] ^ d48[2] ^ d48[3] ^ d48[5] ^ d48[9] ^ d48[13] ^ d48[14] ^ d48[16] ^ d48[19] ^ d48[26] ^ d48[28] ^ d48[29] ^ d48[31] ^ d48[32] ^ d48[33] ^ d48[35] ^ d48[36] ^ d48[39] ^ d48[40] ^ d48[42],
                        c64[0] ^ c64[1] ^ c64[4] ^ c64[8] ^ c64[9] ^ c64[10] ^ c64[11] ^ c64[12] ^ c64[15] ^ c64[17] ^ c64[20] ^ c64[24] ^ c64[25] ^ c64[27] ^ c64[28] ^ c64[29] ^ c64[31] ^ d48[0] ^ d48[1] ^ d48[3] ^ d48[4] ^ d48[9] ^ d48[12] ^ d48[14] ^ d48[15] ^ d48[16] ^ d48[17] ^ d48[20] ^ d48[24] ^ d48[25] ^ d48[26] ^ d48[27] ^ d48[28] ^ d48[31] ^ d48[33] ^ d48[36] ^ d48[40] ^ d48[41] ^ d48[43] ^ d48[44] ^ d48[45] ^ d48[47],
                        c64[1] ^ c64[2] ^ c64[5] ^ c64[8] ^ c64[11] ^ c64[14] ^ c64[15] ^ c64[25] ^ c64[26] ^ c64[30] ^ c64[31] ^ d48[0] ^ d48[1] ^ d48[2] ^ d48[4] ^ d48[5] ^ d48[6] ^ d48[9] ^ d48[12] ^ d48[13] ^ d48[15] ^ d48[17] ^ d48[18] ^ d48[21] ^ d48[24] ^ d48[27] ^ d48[30] ^ d48[31] ^ d48[41] ^ d48[42] ^ d48[46] ^ d48[47],
                        c64[0] ^ c64[2] ^ c64[3] ^ c64[6] ^ c64[9] ^ c64[12] ^ c64[15] ^ c64[16] ^ c64[26] ^ c64[27] ^ c64[31] ^ d48[1] ^ d48[2] ^ d48[3] ^ d48[5] ^ d48[6] ^ d48[7] ^ d48[10] ^ d48[13] ^ d48[14] ^ d48[16] ^ d48[18] ^ d48[19] ^ d48[22] ^ d48[25] ^ d48[28] ^ d48[31] ^ d48[32] ^ d48[42] ^ d48[43] ^ d48[47],
                        c64[1] ^ c64[3] ^ c64[4] ^ c64[7] ^ c64[10] ^ c64[13] ^ c64[16] ^ c64[17] ^ c64[27] ^ c64[28] ^ d48[2] ^ d48[3] ^ d48[4] ^ d48[6] ^ d48[7] ^ d48[8] ^ d48[11] ^ d48[14] ^ d48[15] ^ d48[17] ^ d48[19] ^ d48[20] ^ d48[23] ^ d48[26] ^ d48[29] ^ d48[32] ^ d48[33] ^ d48[43] ^ d48[44],
                        c64[0] ^ c64[2] ^ c64[4] ^ c64[5] ^ c64[8] ^ c64[11] ^ c64[14] ^ c64[17] ^ c64[18] ^ c64[28] ^ c64[29] ^ d48[3] ^ d48[4] ^ d48[5] ^ d48[7] ^ d48[8] ^ d48[9] ^ d48[12] ^ d48[15] ^ d48[16] ^ d48[18] ^ d48[20] ^ d48[21] ^ d48[24] ^ d48[27] ^ d48[30] ^ d48[33] ^ d48[34] ^ d48[44] ^ d48[45],
                        c64[1] ^ c64[3] ^ c64[5] ^ c64[6] ^ c64[8] ^ c64[10] ^ c64[13] ^ c64[14] ^ c64[16] ^ c64[19] ^ c64[21] ^ c64[28] ^ c64[30] ^ c64[31] ^ d48[0] ^ d48[4] ^ d48[5] ^ d48[8] ^ d48[12] ^ d48[13] ^ d48[17] ^ d48[19] ^ d48[21] ^ d48[22] ^ d48[24] ^ d48[26] ^ d48[29] ^ d48[30] ^ d48[32] ^ d48[35] ^ d48[37] ^ d48[44] ^ d48[46] ^ d48[47],
                        c64[2] ^ c64[4] ^ c64[6] ^ c64[7] ^ c64[9] ^ c64[11] ^ c64[14] ^ c64[15] ^ c64[17] ^ c64[20] ^ c64[22] ^ c64[29] ^ c64[31] ^ d48[1] ^ d48[5] ^ d48[6] ^ d48[9] ^ d48[13] ^ d48[14] ^ d48[18] ^ d48[20] ^ d48[22] ^ d48[23] ^ d48[25] ^ d48[27] ^ d48[30] ^ d48[31] ^ d48[33] ^ d48[36] ^ d48[38] ^ d48[45] ^ d48[47],
                        c64[3] ^ c64[5] ^ c64[7] ^ c64[8] ^ c64[10] ^ c64[12] ^ c64[15] ^ c64[16] ^ c64[18] ^ c64[21] ^ c64[23] ^ c64[30] ^ d48[2] ^ d48[6] ^ d48[7] ^ d48[10] ^ d48[14] ^ d48[15] ^ d48[19] ^ d48[21] ^ d48[23] ^ d48[24] ^ d48[26] ^ d48[28] ^ d48[31] ^ d48[32] ^ d48[34] ^ d48[37] ^ d48[39] ^ d48[46],
                        c64[0] ^ c64[4] ^ c64[6] ^ c64[8] ^ c64[9] ^ c64[11] ^ c64[13] ^ c64[16] ^ c64[17] ^ c64[19] ^ c64[22] ^ c64[24] ^ c64[31] ^ d48[3] ^ d48[7] ^ d48[8] ^ d48[11] ^ d48[15] ^ d48[16] ^ d48[20] ^ d48[22] ^ d48[24] ^ d48[25] ^ d48[27] ^ d48[29] ^ d48[32] ^ d48[33] ^ d48[35] ^ d48[38] ^ d48[40] ^ d48[47],
                        c64[0] ^ c64[1] ^ c64[5] ^ c64[7] ^ c64[9] ^ c64[10] ^ c64[12] ^ c64[14] ^ c64[17] ^ c64[18] ^ c64[20] ^ c64[23] ^ c64[25] ^ d48[4] ^ d48[8] ^ d48[9] ^ d48[12] ^ d48[16] ^ d48[17] ^ d48[21] ^ d48[23] ^ d48[25] ^ d48[26] ^ d48[28] ^ d48[30] ^ d48[33] ^ d48[34] ^ d48[36] ^ d48[39] ^ d48[41],
                        c64[1] ^ c64[2] ^ c64[6] ^ c64[8] ^ c64[10] ^ c64[11] ^ c64[13] ^ c64[15] ^ c64[18] ^ c64[19] ^ c64[21] ^ c64[24] ^ c64[26] ^ d48[5] ^ d48[9] ^ d48[10] ^ d48[13] ^ d48[17] ^ d48[18] ^ d48[22] ^ d48[24] ^ d48[26] ^ d48[27] ^ d48[29] ^ d48[31] ^ d48[34] ^ d48[35] ^ d48[37] ^ d48[40] ^ d48[42],
                        c64[0] ^ c64[2] ^ c64[3] ^ c64[7] ^ c64[8] ^ c64[10] ^ c64[11] ^ c64[13] ^ c64[15] ^ c64[18] ^ c64[19] ^ c64[20] ^ c64[21] ^ c64[22] ^ c64[25] ^ c64[27] ^ c64[28] ^ c64[29] ^ c64[31] ^ d48[0] ^ d48[9] ^ d48[11] ^ d48[12] ^ d48[14] ^ d48[16] ^ d48[18] ^ d48[19] ^ d48[23] ^ d48[24] ^ d48[26] ^ d48[27] ^ d48[29] ^ d48[31] ^ d48[34] ^ d48[35] ^ d48[36] ^ d48[37] ^ d48[38] ^ d48[41] ^ d48[43] ^ d48[44] ^ d48[45] ^ d48[47],
                        c64[0] ^ c64[1] ^ c64[3] ^ c64[4] ^ c64[10] ^ c64[11] ^ c64[13] ^ c64[15] ^ c64[18] ^ c64[19] ^ c64[20] ^ c64[22] ^ c64[23] ^ c64[26] ^ c64[30] ^ c64[31] ^ d48[0] ^ d48[1] ^ d48[6] ^ d48[9] ^ d48[13] ^ d48[15] ^ d48[16] ^ d48[17] ^ d48[19] ^ d48[20] ^ d48[26] ^ d48[27] ^ d48[29] ^ d48[31] ^ d48[34] ^ d48[35] ^ d48[36] ^ d48[38] ^ d48[39] ^ d48[42] ^ d48[46] ^ d48[47],
                        c64[0] ^ c64[1] ^ c64[2] ^ c64[4] ^ c64[5] ^ c64[11] ^ c64[12] ^ c64[14] ^ c64[16] ^ c64[19] ^ c64[20] ^ c64[21] ^ c64[23] ^ c64[24] ^ c64[27] ^ c64[31] ^ d48[1] ^ d48[2] ^ d48[7] ^ d48[10] ^ d48[14] ^ d48[16] ^ d48[17] ^ d48[18] ^ d48[20] ^ d48[21] ^ d48[27] ^ d48[28] ^ d48[30] ^ d48[32] ^ d48[35] ^ d48[36] ^ d48[37] ^ d48[39] ^ d48[40] ^ d48[43] ^ d48[47],
                        c64[1] ^ c64[2] ^ c64[3] ^ c64[5] ^ c64[6] ^ c64[12] ^ c64[13] ^ c64[15] ^ c64[17] ^ c64[20] ^ c64[21] ^ c64[22] ^ c64[24] ^ c64[25] ^ c64[28] ^ d48[2] ^ d48[3] ^ d48[8] ^ d48[11] ^ d48[15] ^ d48[17] ^ d48[18] ^ d48[19] ^ d48[21] ^ d48[22] ^ d48[28] ^ d48[29] ^ d48[31] ^ d48[33] ^ d48[36] ^ d48[37] ^ d48[38] ^ d48[40] ^ d48[41] ^ d48[44],
                        c64[2] ^ c64[3] ^ c64[4] ^ c64[6] ^ c64[7] ^ c64[8] ^ c64[9] ^ c64[10] ^ c64[12] ^ c64[15] ^ c64[22] ^ c64[23] ^ c64[25] ^ c64[26] ^ c64[28] ^ c64[31] ^ d48[0] ^ d48[3] ^ d48[4] ^ d48[6] ^ d48[10] ^ d48[18] ^ d48[19] ^ d48[20] ^ d48[22] ^ d48[23] ^ d48[24] ^ d48[25] ^ d48[26] ^ d48[28] ^ d48[31] ^ d48[38] ^ d48[39] ^ d48[41] ^ d48[42] ^ d48[44] ^ d48[47],
                        c64[3] ^ c64[4] ^ c64[5] ^ c64[7] ^ c64[8] ^ c64[9] ^ c64[10] ^ c64[11] ^ c64[13] ^ c64[16] ^ c64[23] ^ c64[24] ^ c64[26] ^ c64[27] ^ c64[29] ^ d48[1] ^ d48[4] ^ d48[5] ^ d48[7] ^ d48[11] ^ d48[19] ^ d48[20] ^ d48[21] ^ d48[23] ^ d48[24] ^ d48[25] ^ d48[26] ^ d48[27] ^ d48[29] ^ d48[32] ^ d48[39] ^ d48[40] ^ d48[42] ^ d48[43] ^ d48[45],
                        c64[4] ^ c64[5] ^ c64[6] ^ c64[8] ^ c64[9] ^ c64[10] ^ c64[11] ^ c64[12] ^ c64[14] ^ c64[17] ^ c64[24] ^ c64[25] ^ c64[27] ^ c64[28] ^ c64[30] ^ d48[2] ^ d48[5] ^ d48[6] ^ d48[8] ^ d48[12] ^ d48[20] ^ d48[21] ^ d48[22] ^ d48[24] ^ d48[25] ^ d48[26] ^ d48[27] ^ d48[28] ^ d48[30] ^ d48[33] ^ d48[40] ^ d48[41] ^ d48[43] ^ d48[44] ^ d48[46],
                        c64[5] ^ c64[6] ^ c64[7] ^ c64[9] ^ c64[10] ^ c64[11] ^ c64[12] ^ c64[13] ^ c64[15] ^ c64[18] ^ c64[25] ^ c64[26] ^ c64[28] ^ c64[29] ^ c64[31] ^ d48[3] ^ d48[6] ^ d48[7] ^ d48[9] ^ d48[13] ^ d48[21] ^ d48[22] ^ d48[23] ^ d48[25] ^ d48[26] ^ d48[27] ^ d48[28] ^ d48[29] ^ d48[31] ^ d48[34] ^ d48[41] ^ d48[42] ^ d48[44] ^ d48[45] ^ d48[47],
                        c64[6] ^ c64[7] ^ c64[8] ^ c64[10] ^ c64[11] ^ c64[12] ^ c64[13] ^ c64[14] ^ c64[16] ^ c64[19] ^ c64[26] ^ c64[27] ^ c64[29] ^ c64[30] ^ d48[4] ^ d48[7] ^ d48[8] ^ d48[10] ^ d48[14] ^ d48[22] ^ d48[23] ^ d48[24] ^ d48[26] ^ d48[27] ^ d48[28] ^ d48[29] ^ d48[30] ^ d48[32] ^ d48[35] ^ d48[42] ^ d48[43] ^ d48[45] ^ d48[46],
                        c64[7] ^ c64[8] ^ c64[9] ^ c64[11] ^ c64[12] ^ c64[13] ^ c64[14] ^ c64[15] ^ c64[17] ^ c64[20] ^ c64[27] ^ c64[28] ^ c64[30] ^ c64[31] ^ d48[5] ^ d48[8] ^ d48[9] ^ d48[11] ^ d48[15] ^ d48[23] ^ d48[24] ^ d48[25] ^ d48[27] ^ d48[28] ^ d48[29] ^ d48[30] ^ d48[31] ^ d48[33] ^ d48[36] ^ d48[43] ^ d48[44] ^ d48[46] ^ d48[47]
                    )
                ),

                # 64-bit full madness begins here
                c64.eq(
                    Cat(
                        c64[0] ^ c64[2] ^ c64[5] ^ c64[12] ^ c64[13] ^ c64[15] ^ c64[16] ^ c64[18] ^ c64[21] ^ c64[22] ^ c64[23] ^ c64[26] ^ c64[28] ^ c64[29] ^ c64[31] ^ d64[0] ^ d64[6] ^ d64[9] ^ d64[10] ^ d64[12] ^ d64[16] ^ d64[24] ^ d64[25] ^ d64[26] ^ d64[28] ^ d64[29] ^ d64[30] ^ d64[31] ^ d64[32] ^ d64[34] ^ d64[37] ^ d64[44] ^ d64[45] ^ d64[47] ^ d64[48] ^ d64[50] ^ d64[53] ^ d64[54] ^ d64[55] ^ d64[58] ^ d64[60] ^ d64[61] ^ d64[63],
                        c64[1] ^ c64[2] ^ c64[3] ^ c64[5] ^ c64[6] ^ c64[12] ^ c64[14] ^ c64[15] ^ c64[17] ^ c64[18] ^ c64[19] ^ c64[21] ^ c64[24] ^ c64[26] ^ c64[27] ^ c64[28] ^ c64[30] ^ c64[31] ^ d64[0] ^ d64[1] ^ d64[6] ^ d64[7] ^ d64[9] ^ d64[11] ^ d64[12] ^ d64[13] ^ d64[16] ^ d64[17] ^ d64[24] ^ d64[27] ^ d64[28] ^ d64[33] ^ d64[34] ^ d64[35] ^ d64[37] ^ d64[38] ^ d64[44] ^ d64[46] ^ d64[47] ^ d64[49] ^ d64[50] ^ d64[51] ^ d64[53] ^ d64[56] ^ d64[58] ^ d64[59] ^ d64[60] ^ d64[62] ^ d64[63],
                        c64[0] ^ c64[3] ^ c64[4] ^ c64[5] ^ c64[6] ^ c64[7] ^ c64[12] ^ c64[19] ^ c64[20] ^ c64[21] ^ c64[23] ^ c64[25] ^ c64[26] ^ c64[27] ^ d64[0] ^ d64[1] ^ d64[2] ^ d64[6] ^ d64[7] ^ d64[8] ^ d64[9] ^ d64[13] ^ d64[14] ^ d64[16] ^ d64[17] ^ d64[18] ^ d64[24] ^ d64[26] ^ d64[30] ^ d64[31] ^ d64[32] ^ d64[35] ^ d64[36] ^ d64[37] ^ d64[38] ^ d64[39] ^ d64[44] ^ d64[51] ^ d64[52] ^ d64[53] ^ d64[55] ^ d64[57] ^ d64[58] ^ d64[59],
                        c64[0] ^ c64[1] ^ c64[4] ^ c64[5] ^ c64[6] ^ c64[7] ^ c64[8] ^ c64[13] ^ c64[20] ^ c64[21] ^ c64[22] ^ c64[24] ^ c64[26] ^ c64[27] ^ c64[28] ^ d64[1] ^ d64[2] ^ d64[3] ^ d64[7] ^ d64[8] ^ d64[9] ^ d64[10] ^ d64[14] ^ d64[15] ^ d64[17] ^ d64[18] ^ d64[19] ^ d64[25] ^ d64[27] ^ d64[31] ^ d64[32] ^ d64[33] ^ d64[36] ^ d64[37] ^ d64[38] ^ d64[39] ^ d64[40] ^ d64[45] ^ d64[52] ^ d64[53] ^ d64[54] ^ d64[56] ^ d64[58] ^ d64[59] ^ d64[60],
                        c64[1] ^ c64[6] ^ c64[7] ^ c64[8] ^ c64[9] ^ c64[12] ^ c64[13] ^ c64[14] ^ c64[15] ^ c64[16] ^ c64[18] ^ c64[25] ^ c64[26] ^ c64[27] ^ c64[31] ^ d64[0] ^ d64[2] ^ d64[3] ^ d64[4] ^ d64[6] ^ d64[8] ^ d64[11] ^ d64[12] ^ d64[15] ^ d64[18] ^ d64[19] ^ d64[20] ^ d64[24] ^ d64[25] ^ d64[29] ^ d64[30] ^ d64[31] ^ d64[33] ^ d64[38] ^ d64[39] ^ d64[40] ^ d64[41] ^ d64[44] ^ d64[45] ^ d64[46] ^ d64[47] ^ d64[48] ^ d64[50] ^ d64[57] ^ d64[58] ^ d64[59] ^ d64[63],
                        c64[5] ^ c64[7] ^ c64[8] ^ c64[9] ^ c64[10] ^ c64[12] ^ c64[14] ^ c64[17] ^ c64[18] ^ c64[19] ^ c64[21] ^ c64[22] ^ c64[23] ^ c64[27] ^ c64[29] ^ c64[31] ^ d64[0] ^ d64[1] ^ d64[3] ^ d64[4] ^ d64[5] ^ d64[6] ^ d64[7] ^ d64[10] ^ d64[13] ^ d64[19] ^ d64[20] ^ d64[21] ^ d64[24] ^ d64[28] ^ d64[29] ^ d64[37] ^ d64[39] ^ d64[40] ^ d64[41] ^ d64[42] ^ d64[44] ^ d64[46] ^ d64[49] ^ d64[50] ^ d64[51] ^ d64[53] ^ d64[54] ^ d64[55] ^ d64[59] ^ d64[61] ^ d64[63],
                        c64[6] ^ c64[8] ^ c64[9] ^ c64[10] ^ c64[11] ^ c64[13] ^ c64[15] ^ c64[18] ^ c64[19] ^ c64[20] ^ c64[22] ^ c64[23] ^ c64[24] ^ c64[28] ^ c64[30] ^ d64[1] ^ d64[2] ^ d64[4] ^ d64[5] ^ d64[6] ^ d64[7] ^ d64[8] ^ d64[11] ^ d64[14] ^ d64[20] ^ d64[21] ^ d64[22] ^ d64[25] ^ d64[29] ^ d64[30] ^ d64[38] ^ d64[40] ^ d64[41] ^ d64[42] ^ d64[43] ^ d64[45] ^ d64[47] ^ d64[50] ^ d64[51] ^ d64[52] ^ d64[54] ^ d64[55] ^ d64[56] ^ d64[60] ^ d64[62],
                        c64[0] ^ c64[2] ^ c64[5] ^ c64[7] ^ c64[9] ^ c64[10] ^ c64[11] ^ c64[13] ^ c64[14] ^ c64[15] ^ c64[18] ^ c64[19] ^ c64[20] ^ c64[22] ^ c64[24] ^ c64[25] ^ c64[26] ^ c64[28] ^ d64[0] ^ d64[2] ^ d64[3] ^ d64[5] ^ d64[7] ^ d64[8] ^ d64[10] ^ d64[15] ^ d64[16] ^ d64[21] ^ d64[22] ^ d64[23] ^ d64[24] ^ d64[25] ^ d64[28] ^ d64[29] ^ d64[32] ^ d64[34] ^ d64[37] ^ d64[39] ^ d64[41] ^ d64[42] ^ d64[43] ^ d64[45] ^ d64[46] ^ d64[47] ^ d64[50] ^ d64[51] ^ d64[52] ^ d64[54] ^ d64[56] ^ d64[57] ^ d64[58] ^ d64[60],
                        c64[0] ^ c64[1] ^ c64[2] ^ c64[3] ^ c64[5] ^ c64[6] ^ c64[8] ^ c64[10] ^ c64[11] ^ c64[13] ^ c64[14] ^ c64[18] ^ c64[19] ^ c64[20] ^ c64[22] ^ c64[25] ^ c64[27] ^ c64[28] ^ c64[31] ^ d64[0] ^ d64[1] ^ d64[3] ^ d64[4] ^ d64[8] ^ d64[10] ^ d64[11] ^ d64[12] ^ d64[17] ^ d64[22] ^ d64[23] ^ d64[28] ^ d64[31] ^ d64[32] ^ d64[33] ^ d64[34] ^ d64[35] ^ d64[37] ^ d64[38] ^ d64[40] ^ d64[42] ^ d64[43] ^ d64[45] ^ d64[46] ^ d64[50] ^ d64[51] ^ d64[52] ^ d64[54] ^ d64[57] ^ d64[59] ^ d64[60] ^ d64[63],
                        c64[0] ^ c64[1] ^ c64[2] ^ c64[3] ^ c64[4] ^ c64[6] ^ c64[7] ^ c64[9] ^ c64[11] ^ c64[12] ^ c64[14] ^ c64[15] ^ c64[19] ^ c64[20] ^ c64[21] ^ c64[23] ^ c64[26] ^ c64[28] ^ c64[29] ^ d64[1] ^ d64[2] ^ d64[4] ^ d64[5] ^ d64[9] ^ d64[11] ^ d64[12] ^ d64[13] ^ d64[18] ^ d64[23] ^ d64[24] ^ d64[29] ^ d64[32] ^ d64[33] ^ d64[34] ^ d64[35] ^ d64[36] ^ d64[38] ^ d64[39] ^ d64[41] ^ d64[43] ^ d64[44] ^ d64[46] ^ d64[47] ^ d64[51] ^ d64[52] ^ d64[53] ^ d64[55] ^ d64[58] ^ d64[60] ^ d64[61],
                        c64[0] ^ c64[1] ^ c64[3] ^ c64[4] ^ c64[7] ^ c64[8] ^ c64[10] ^ c64[18] ^ c64[20] ^ c64[23] ^ c64[24] ^ c64[26] ^ c64[27] ^ c64[28] ^ c64[30] ^ c64[31] ^ d64[0] ^ d64[2] ^ d64[3] ^ d64[5] ^ d64[9] ^ d64[13] ^ d64[14] ^ d64[16] ^ d64[19] ^ d64[26] ^ d64[28] ^ d64[29] ^ d64[31] ^ d64[32] ^ d64[33] ^ d64[35] ^ d64[36] ^ d64[39] ^ d64[40] ^ d64[42] ^ d64[50] ^ d64[52] ^ d64[55] ^ d64[56] ^ d64[58] ^ d64[59] ^ d64[60] ^ d64[62] ^ d64[63],
                        c64[1] ^ c64[4] ^ c64[8] ^ c64[9] ^ c64[11] ^ c64[12] ^ c64[13] ^ c64[15] ^ c64[16] ^ c64[18] ^ c64[19] ^ c64[22] ^ c64[23] ^ c64[24] ^ c64[25] ^ c64[26] ^ c64[27] ^ d64[0] ^ d64[1] ^ d64[3] ^ d64[4] ^ d64[9] ^ d64[12] ^ d64[14] ^ d64[15] ^ d64[16] ^ d64[17] ^ d64[20] ^ d64[24] ^ d64[25] ^ d64[26] ^ d64[27] ^ d64[28] ^ d64[31] ^ d64[33] ^ d64[36] ^ d64[40] ^ d64[41] ^ d64[43] ^ d64[44] ^ d64[45] ^ d64[47] ^ d64[48] ^ d64[50] ^ d64[51] ^ d64[54] ^ d64[55] ^ d64[56] ^ d64[57] ^ d64[58] ^ d64[59],
                        c64[9] ^ c64[10] ^ c64[14] ^ c64[15] ^ c64[17] ^ c64[18] ^ c64[19] ^ c64[20] ^ c64[21] ^ c64[22] ^ c64[24] ^ c64[25] ^ c64[27] ^ c64[29] ^ c64[31] ^ d64[0] ^ d64[1] ^ d64[2] ^ d64[4] ^ d64[5] ^ d64[6] ^ d64[9] ^ d64[12] ^ d64[13] ^ d64[15] ^ d64[17] ^ d64[18] ^ d64[21] ^ d64[24] ^ d64[27] ^ d64[30] ^ d64[31] ^ d64[41] ^ d64[42] ^ d64[46] ^ d64[47] ^ d64[49] ^ d64[50] ^ d64[51] ^ d64[52] ^ d64[53] ^ d64[54] ^ d64[56] ^ d64[57] ^ d64[59] ^ d64[61] ^ d64[63],
                        c64[0] ^ c64[10] ^ c64[11] ^ c64[15] ^ c64[16] ^ c64[18] ^ c64[19] ^ c64[20] ^ c64[21] ^ c64[22] ^ c64[23] ^ c64[25] ^ c64[26] ^ c64[28] ^ c64[30] ^ d64[1] ^ d64[2] ^ d64[3] ^ d64[5] ^ d64[6] ^ d64[7] ^ d64[10] ^ d64[13] ^ d64[14] ^ d64[16] ^ d64[18] ^ d64[19] ^ d64[22] ^ d64[25] ^ d64[28] ^ d64[31] ^ d64[32] ^ d64[42] ^ d64[43] ^ d64[47] ^ d64[48] ^ d64[50] ^ d64[51] ^ d64[52] ^ d64[53] ^ d64[54] ^ d64[55] ^ d64[57] ^ d64[58] ^ d64[60] ^ d64[62],
                        c64[0] ^ c64[1] ^ c64[11] ^ c64[12] ^ c64[16] ^ c64[17] ^ c64[19] ^ c64[20] ^ c64[21] ^ c64[22] ^ c64[23] ^ c64[24] ^ c64[26] ^ c64[27] ^ c64[29] ^ c64[31] ^ d64[2] ^ d64[3] ^ d64[4] ^ d64[6] ^ d64[7] ^ d64[8] ^ d64[11] ^ d64[14] ^ d64[15] ^ d64[17] ^ d64[19] ^ d64[20] ^ d64[23] ^ d64[26] ^ d64[29] ^ d64[32] ^ d64[33] ^ d64[43] ^ d64[44] ^ d64[48] ^ d64[49] ^ d64[51] ^ d64[52] ^ d64[53] ^ d64[54] ^ d64[55] ^ d64[56] ^ d64[58] ^ d64[59] ^ d64[61] ^ d64[63],
                        c64[1] ^ c64[2] ^ c64[12] ^ c64[13] ^ c64[17] ^ c64[18] ^ c64[20] ^ c64[21] ^ c64[22] ^ c64[23] ^ c64[24] ^ c64[25] ^ c64[27] ^ c64[28] ^ c64[30] ^ d64[3] ^ d64[4] ^ d64[5] ^ d64[7] ^ d64[8] ^ d64[9] ^ d64[12] ^ d64[15] ^ d64[16] ^ d64[18] ^ d64[20] ^ d64[21] ^ d64[24] ^ d64[27] ^ d64[30] ^ d64[33] ^ d64[34] ^ d64[44] ^ d64[45] ^ d64[49] ^ d64[50] ^ d64[52] ^ d64[53] ^ d64[54] ^ d64[55] ^ d64[56] ^ d64[57] ^ d64[59] ^ d64[60] ^ d64[62],
                        c64[0] ^ c64[3] ^ c64[5] ^ c64[12] ^ c64[14] ^ c64[15] ^ c64[16] ^ c64[19] ^ c64[24] ^ c64[25] ^ d64[0] ^ d64[4] ^ d64[5] ^ d64[8] ^ d64[12] ^ d64[13] ^ d64[17] ^ d64[19] ^ d64[21] ^ d64[22] ^ d64[24] ^ d64[26] ^ d64[29] ^ d64[30] ^ d64[32] ^ d64[35] ^ d64[37] ^ d64[44] ^ d64[46] ^ d64[47] ^ d64[48] ^ d64[51] ^ d64[56] ^ d64[57],
                        c64[1] ^ c64[4] ^ c64[6] ^ c64[13] ^ c64[15] ^ c64[16] ^ c64[17] ^ c64[20] ^ c64[25] ^ c64[26] ^ d64[1] ^ d64[5] ^ d64[6] ^ d64[9] ^ d64[13] ^ d64[14] ^ d64[18] ^ d64[20] ^ d64[22] ^ d64[23] ^ d64[25] ^ d64[27] ^ d64[30] ^ d64[31] ^ d64[33] ^ d64[36] ^ d64[38] ^ d64[45] ^ d64[47] ^ d64[48] ^ d64[49] ^ d64[52] ^ d64[57] ^ d64[58],
                        c64[0] ^ c64[2] ^ c64[5] ^ c64[7] ^ c64[14] ^ c64[16] ^ c64[17] ^ c64[18] ^ c64[21] ^ c64[26] ^ c64[27] ^ d64[2] ^ d64[6] ^ d64[7] ^ d64[10] ^ d64[14] ^ d64[15] ^ d64[19] ^ d64[21] ^ d64[23] ^ d64[24] ^ d64[26] ^ d64[28] ^ d64[31] ^ d64[32] ^ d64[34] ^ d64[37] ^ d64[39] ^ d64[46] ^ d64[48] ^ d64[49] ^ d64[50] ^ d64[53] ^ d64[58] ^ d64[59],
                        c64[0] ^ c64[1] ^ c64[3] ^ c64[6] ^ c64[8] ^ c64[15] ^ c64[17] ^ c64[18] ^ c64[19] ^ c64[22] ^ c64[27] ^ c64[28] ^ d64[3] ^ d64[7] ^ d64[8] ^ d64[11] ^ d64[15] ^ d64[16] ^ d64[20] ^ d64[22] ^ d64[24] ^ d64[25] ^ d64[27] ^ d64[29] ^ d64[32] ^ d64[33] ^ d64[35] ^ d64[38] ^ d64[40] ^ d64[47] ^ d64[49] ^ d64[50] ^ d64[51] ^ d64[54] ^ d64[59] ^ d64[60],
                        c64[1] ^ c64[2] ^ c64[4] ^ c64[7] ^ c64[9] ^ c64[16] ^ c64[18] ^ c64[19] ^ c64[20] ^ c64[23] ^ c64[28] ^ c64[29] ^ d64[4] ^ d64[8] ^ d64[9] ^ d64[12] ^ d64[16] ^ d64[17] ^ d64[21] ^ d64[23] ^ d64[25] ^ d64[26] ^ d64[28] ^ d64[30] ^ d64[33] ^ d64[34] ^ d64[36] ^ d64[39] ^ d64[41] ^ d64[48] ^ d64[50] ^ d64[51] ^ d64[52] ^ d64[55] ^ d64[60] ^ d64[61],
                        c64[2] ^ c64[3] ^ c64[5] ^ c64[8] ^ c64[10] ^ c64[17] ^ c64[19] ^ c64[20] ^ c64[21] ^ c64[24] ^ c64[29] ^ c64[30] ^ d64[5] ^ d64[9] ^ d64[10] ^ d64[13] ^ d64[17] ^ d64[18] ^ d64[22] ^ d64[24] ^ d64[26] ^ d64[27] ^ d64[29] ^ d64[31] ^ d64[34] ^ d64[35] ^ d64[37] ^ d64[40] ^ d64[42] ^ d64[49] ^ d64[51] ^ d64[52] ^ d64[53] ^ d64[56] ^ d64[61] ^ d64[62],
                        c64[2] ^ c64[3] ^ c64[4] ^ c64[5] ^ c64[6] ^ c64[9] ^ c64[11] ^ c64[12] ^ c64[13] ^ c64[15] ^ c64[16] ^ c64[20] ^ c64[23] ^ c64[25] ^ c64[26] ^ c64[28] ^ c64[29] ^ c64[30] ^ d64[0] ^ d64[9] ^ d64[11] ^ d64[12] ^ d64[14] ^ d64[16] ^ d64[18] ^ d64[19] ^ d64[23] ^ d64[24] ^ d64[26] ^ d64[27] ^ d64[29] ^ d64[31] ^ d64[34] ^ d64[35] ^ d64[36] ^ d64[37] ^ d64[38] ^ d64[41] ^ d64[43] ^ d64[44] ^ d64[45] ^ d64[47] ^ d64[48] ^ d64[52] ^ d64[55] ^ d64[57] ^ d64[58] ^ d64[60] ^ d64[61] ^ d64[62],
                        c64[2] ^ c64[3] ^ c64[4] ^ c64[6] ^ c64[7] ^ c64[10] ^ c64[14] ^ c64[15] ^ c64[17] ^ c64[18] ^ c64[22] ^ c64[23] ^ c64[24] ^ c64[27] ^ c64[28] ^ c64[30] ^ d64[0] ^ d64[1] ^ d64[6] ^ d64[9] ^ d64[13] ^ d64[15] ^ d64[16] ^ d64[17] ^ d64[19] ^ d64[20] ^ d64[26] ^ d64[27] ^ d64[29] ^ d64[31] ^ d64[34] ^ d64[35] ^ d64[36] ^ d64[38] ^ d64[39] ^ d64[42] ^ d64[46] ^ d64[47] ^ d64[49] ^ d64[50] ^ d64[54] ^ d64[55] ^ d64[56] ^ d64[59] ^ d64[60] ^ d64[62],
                        c64[0] ^ c64[3] ^ c64[4] ^ c64[5] ^ c64[7] ^ c64[8] ^ c64[11] ^ c64[15] ^ c64[16] ^ c64[18] ^ c64[19] ^ c64[23] ^ c64[24] ^ c64[25] ^ c64[28] ^ c64[29] ^ c64[31] ^ d64[1] ^ d64[2] ^ d64[7] ^ d64[10] ^ d64[14] ^ d64[16] ^ d64[17] ^ d64[18] ^ d64[20] ^ d64[21] ^ d64[27] ^ d64[28] ^ d64[30] ^ d64[32] ^ d64[35] ^ d64[36] ^ d64[37] ^ d64[39] ^ d64[40] ^ d64[43] ^ d64[47] ^ d64[48] ^ d64[50] ^ d64[51] ^ d64[55] ^ d64[56] ^ d64[57] ^ d64[60] ^ d64[61] ^ d64[63],
                        c64[1] ^ c64[4] ^ c64[5] ^ c64[6] ^ c64[8] ^ c64[9] ^ c64[12] ^ c64[16] ^ c64[17] ^ c64[19] ^ c64[20] ^ c64[24] ^ c64[25] ^ c64[26] ^ c64[29] ^ c64[30] ^ d64[2] ^ d64[3] ^ d64[8] ^ d64[11] ^ d64[15] ^ d64[17] ^ d64[18] ^ d64[19] ^ d64[21] ^ d64[22] ^ d64[28] ^ d64[29] ^ d64[31] ^ d64[33] ^ d64[36] ^ d64[37] ^ d64[38] ^ d64[40] ^ d64[41] ^ d64[44] ^ d64[48] ^ d64[49] ^ d64[51] ^ d64[52] ^ d64[56] ^ d64[57] ^ d64[58] ^ d64[61] ^ d64[62],
                        c64[6] ^ c64[7] ^ c64[9] ^ c64[10] ^ c64[12] ^ c64[15] ^ c64[16] ^ c64[17] ^ c64[20] ^ c64[22] ^ c64[23] ^ c64[25] ^ c64[27] ^ c64[28] ^ c64[29] ^ c64[30] ^ d64[0] ^ d64[3] ^ d64[4] ^ d64[6] ^ d64[10] ^ d64[18] ^ d64[19] ^ d64[20] ^ d64[22] ^ d64[23] ^ d64[24] ^ d64[25] ^ d64[26] ^ d64[28] ^ d64[31] ^ d64[38] ^ d64[39] ^ d64[41] ^ d64[42] ^ d64[44] ^ d64[47] ^ d64[48] ^ d64[49] ^ d64[52] ^ d64[54] ^ d64[55] ^ d64[57] ^ d64[59] ^ d64[60] ^ d64[61] ^ d64[62],
                        c64[0] ^ c64[7] ^ c64[8] ^ c64[10] ^ c64[11] ^ c64[13] ^ c64[16] ^ c64[17] ^ c64[18] ^ c64[21] ^ c64[23] ^ c64[24] ^ c64[26] ^ c64[28] ^ c64[29] ^ c64[30] ^ c64[31] ^ d64[1] ^ d64[4] ^ d64[5] ^ d64[7] ^ d64[11] ^ d64[19] ^ d64[20] ^ d64[21] ^ d64[23] ^ d64[24] ^ d64[25] ^ d64[26] ^ d64[27] ^ d64[29] ^ d64[32] ^ d64[39] ^ d64[40] ^ d64[42] ^ d64[43] ^ d64[45] ^ d64[48] ^ d64[49] ^ d64[50] ^ d64[53] ^ d64[55] ^ d64[56] ^ d64[58] ^ d64[60] ^ d64[61] ^ d64[62] ^ d64[63],
                        c64[1] ^ c64[8] ^ c64[9] ^ c64[11] ^ c64[12] ^ c64[14] ^ c64[17] ^ c64[18] ^ c64[19] ^ c64[22] ^ c64[24] ^ c64[25] ^ c64[27] ^ c64[29] ^ c64[30] ^ c64[31] ^ d64[2] ^ d64[5] ^ d64[6] ^ d64[8] ^ d64[12] ^ d64[20] ^ d64[21] ^ d64[22] ^ d64[24] ^ d64[25] ^ d64[26] ^ d64[27] ^ d64[28] ^ d64[30] ^ d64[33] ^ d64[40] ^ d64[41] ^ d64[43] ^ d64[44] ^ d64[46] ^ d64[49] ^ d64[50] ^ d64[51] ^ d64[54] ^ d64[56] ^ d64[57] ^ d64[59] ^ d64[61] ^ d64[62] ^ d64[63],
                        c64[2] ^ c64[9] ^ c64[10] ^ c64[12] ^ c64[13] ^ c64[15] ^ c64[18] ^ c64[19] ^ c64[20] ^ c64[23] ^ c64[25] ^ c64[26] ^ c64[28] ^ c64[30] ^ c64[31] ^ d64[3] ^ d64[6] ^ d64[7] ^ d64[9] ^ d64[13] ^ d64[21] ^ d64[22] ^ d64[23] ^ d64[25] ^ d64[26] ^ d64[27] ^ d64[28] ^ d64[29] ^ d64[31] ^ d64[34] ^ d64[41] ^ d64[42] ^ d64[44] ^ d64[45] ^ d64[47] ^ d64[50] ^ d64[51] ^ d64[52] ^ d64[55] ^ d64[57] ^ d64[58] ^ d64[60] ^ d64[62] ^ d64[63],
                        c64[0] ^ c64[3] ^ c64[10] ^ c64[11] ^ c64[13] ^ c64[14] ^ c64[16] ^ c64[19] ^ c64[20] ^ c64[21] ^ c64[24] ^ c64[26] ^ c64[27] ^ c64[29] ^ c64[31] ^ d64[4] ^ d64[7] ^ d64[8] ^ d64[10] ^ d64[14] ^ d64[22] ^ d64[23] ^ d64[24] ^ d64[26] ^ d64[27] ^ d64[28] ^ d64[29] ^ d64[30] ^ d64[32] ^ d64[35] ^ d64[42] ^ d64[43] ^ d64[45] ^ d64[46] ^ d64[48] ^ d64[51] ^ d64[52] ^ d64[53] ^ d64[56] ^ d64[58] ^ d64[59] ^ d64[61] ^ d64[63],
                        c64[1] ^ c64[4] ^ c64[11] ^ c64[12] ^ c64[14] ^ c64[15] ^ c64[17] ^ c64[20] ^ c64[21] ^ c64[22] ^ c64[25] ^ c64[27] ^ c64[28] ^ c64[30] ^ d64[5] ^ d64[8] ^ d64[9] ^ d64[11] ^ d64[15] ^ d64[23] ^ d64[24] ^ d64[25] ^ d64[27] ^ d64[28] ^ d64[29] ^ d64[30] ^ d64[31] ^ d64[33] ^ d64[36] ^ d64[43] ^ d64[44] ^ d64[46] ^ d64[47] ^ d64[49] ^ d64[52] ^ d64[53] ^ d64[54] ^ d64[57] ^ d64[59] ^ d64[60] ^ d64[62]
                    )
                )
            ]

        return m


def sample_packet():
  return [
        0xfe, 0xdc, 0xba, 0x98, 0x76, 0x54,              # destination MAC
        0x01, 0x23, 0x45, 0x67, 0x89, 0xab,              # source MAC
        0x08, 0x00,                                      # ethertype
        0x01, 0x00, 0x02, 0x00, 0x03, 0x00, 0x04, 0x00,  # data word 0
        0x05, 0x00, 0x06, 0x00, 0x07, 0x00, 0x08, 0x00,  # data word 1
        0x09, 0x00, 0x0a, 0x00, 0x0b, 0x00, 0x0c, 0x00,  # data word 2
        #0x00, 0x0d, 0x00, 0x0e, 0x00, 0x0f, 0x00, 0x10,  # data word 3
        #0x00, 0x11, 0x00, 0x12, 0x00, 0x13, 0x00, 0x14,  # data word 4
        #0x00, 0x15, 0x00, 0x16, 0x00, 0x17, 0x00, 0x18,  # data word 5
    ]


def python_fcs(p):
    import zlib
    return zlib.crc32(bytes(p))


def sample_packet_64b():
    p = sample_packet()
    # iterate through 64 bits at a time
    words = []
    for i in range(0, round((len(p)-1)/8)):
        # assemble 64 bit chunk
        w = 0
        for b in range(0, 8):
            w += p[i*8 + b] << (b * 8)
        words.append(w)
    return words


def list_to_uint64(p):
    u = 0
    v = 0
    for b in range(8):
        if b < len(p):
            u += p[b] << (b * 8)
            v += 1 << b
    return u, v


def zero_pad(d, max_len):
    out = []
    out += d
    if len(out) < max_len:
        out += [0] * (max_len - len(out))
    return out


if __name__ == '__main__':

    from nmigen.sim import *
    fcs = FCS()
    sim = Simulator(fcs)
    sim.add_clock(10e-9)

    def test():
        data = sample_packet()
        print(f'data              software  hw64      hw48      hw')
        print(f'======================================================')
        yield
        yield fcs.clear.eq(True)
        yield
        yield
        yield fcs.clear.eq(False)

        for i in range(15):
            offset = i * 8
            data64, bytes_valid = list_to_uint64(data[offset:(offset+8)])
            yield fcs.data.eq(data64)
            yield fcs.valid.eq(bytes_valid)

            yield

            if i >= 3:
                old_offset = (i - 3) * 8
                old_input, old_valid = list_to_uint64(data[old_offset:(old_offset+8)])
                #d = zero_pad(data[0:((i-1)*8)], (i-1) * 8)
                d = data[0:((i-2)*8)]
                crc_so_far = python_fcs(d)
                c = yield fcs.crc
                c64 = yield fcs.crc64
                c48 = yield fcs.crc48

                print(f'{old_input:016x}  {crc_so_far:08x}  {c64:08x}  {c48:08x}  {c:08x}')

    sim.add_sync_process(test)
    with sim.write_vcd("fcs.vcd"):
        sim.run()

    #from nmigen.back import verilog
    #with open('fcs.v', 'w') as f:
    #    f.write(verilog.convert(fcs, ports=[], strip_internal_attrs=True))
